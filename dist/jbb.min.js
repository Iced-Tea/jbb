/* JBB Binary Bundle Loader - https://github.com/wavesoft/jbb */
var JBBBinaryLoader=function(r){function t(i){if(e[i])return e[i].exports;var s=e[i]={exports:{},id:i,loaded:!1};return r[i].call(s.exports,s,s.exports,t),s.loaded=!0,s.exports}var e={};return t.m=r,t.c=e,t.p="",t(0)}([function(r,t,e){"use strict";function i(r,t){var e=r.readStringLT(),i=new Blob([r.readTypedArray(m.UINT8,t)],{type:e});return URL.createObjectURL(i)}function s(r,t,e){var s,n=[m.UINT8,m.UINT16,m.UINT32,m.FLOAT64][t],a=r.readTypedNum(n);if(0===e)return s=String.fromCharCode.apply(null,r.readTypedArray(m.UINT8,a));if(1===e)return s=String.fromCharCode.apply(null,r.readTypedArray(m.UINT16,a));if(2===e){var o=document.createElement("img");return o.src=i(r,a),o}if(4===e){var o=document.createElement("script");return o.src=i(r,a),o}if(7===e)return i(r,a);throw new y.AssertError("Unknown buffer type #"+e+"!")}function n(r,t,e){if(!(32&e&&32!==(48&e))){var i=e;32&e&&(i=r.readTypedNum(m.UINT8)|(15&e)<<8);var s=r.ot.ENTITIES[i];if(void 0===s)throw new y.AssertError("Could not found known object entity #"+i+"!");var n=s[1](s[0]);r.iref_table.push(n);var a=T(r,t);return s[2](n,r.ot.PROPERTIES[i],a),n}if(56!==(60&e)){if(48===(56&e)){var i=(7&e)<<8|r.readTypedNum(m.UINT8),o=r.factory_plain[i];if(void 0===o)throw new y.AssertError("Could not found simple object signature with id #"+i+"!");var h=T(r,t);return o(h)}throw new y.AssertError("Unexpected object opcode 0x"+e.toString(16)+"!")}var u=3&e;switch(u){case 0:var f=r.readTypedNum(m.FLOAT64);10*r.readTypedNum(m.INT8);return new Date(f);default:throw new y.AssertError("Unknown primitive object with POID #"+u+"!")}}function a(r,t,e,i){for(var s=new g[v.FROM[i]](e),n=v.TO[i],a=r.readTypedNum(v.FROM[i]),o=r.readTypedNum(m.FLOAT64),h=r.readTypedArray(n,e),u=0;e>u;++u)s[u]=a+h[u]*o,console.log("<<<",h[u],"->",s[u]);return s}function o(r,t,e,i){var s=new g[w.FROM[i]](e),n=r.readTypedNum(w.FROM[i]),a=r.readTypedArray(w.TO[i],e-1);s[0]=n;for(var o=0,h=a.length;h>o;++o)n+=a[o],s[o+1]=n;return s}function h(r,t){var e=r.readTypedNum(m.UINT16),i=r.signature_table[e],s=r.factory_plain_bulk[e];if(!i)throw new y.AssertError("Unknown plain object with signature #"+e+"!");for(var n=[],a=0,o=i.length;o>a;++a)n.push(T(r,t));for(var h=[],u=n[0].length,a=0;u>a;++a)h.push(s(n,a));return h}function u(r,t,e){var i,s,n,a,o,h=r.readTypedNum(m.UINT16),u=r.ot.PROPERTIES[h],f=r.ot.ENTITIES[h],c=u.length,d=[],l=(Array(e),Array(e)),p=0,N=0,I=0,b=[],w=[],v=0,g="";for(p=0;e>p;)switch(n=r.readTypedNum(m.UINT8),a=63&n,n=192&n){case A.DEFINE:for(N=0;a>N;N++)i=f[1](f[0]),r.iref_table.push(i),w.push(i);p+=a,b.push([n,a]);break;case A.IREF:s=r.readTypedNum(m.UINT16),a=a<<16|s,p+=1,b.push([n,a]);break;case A.XREF:a=r.readStringLT(),p+=1,b.push([n,a]);break;default:throw new y.AssertError("Unknown bulk array op-code 0x"+n.toString(16)+"!")}for(p=0;c>p;++p)d.push(T(r,t)),g&&(g+=","),g+="p["+p+"][i]";for(o=new Function("p","i","return ["+g+"]"),p=0,I=0;I<b.length;I++)switch(n=b[I][0],a=b[I][1],n){case A.DEFINE:for(N=0;a>N;N++)i=w[v],f[2](i,u,o(d,v)),l[p++]=i,v++;break;case A.IREF:if(a>=r.iref_table.length)throw new y.IRefError("Invalid IREF #"+a+"!");l[p++]=r.iref_table[a];break;case A.XREF:if(void 0===t[a])throw new y.XRefError("Cannot import undefined external reference "+a+"!");l[p++]=t[a]}return l}function f(r,t){for(var e,i=r.readTypedNum(m.UINT8),s=[];127!==i;){if(e=c(r,t,i),void 0===e.length)throw new y.AssertError("Encountered non-array chunk as part of chunked array!");s.push.apply(s,e),i=r.readTypedNum(m.UINT8)}return s}function c(r,t,e){var i,s,n,c,d,l=[];if(108===e)return h(r,t);if(110===e){for(c=r.readTypedNum(m.UINT8),i=0;c>i;++i)l.push(T(r,t));return l}if(111===e)return f(r,t);if(126===e)return[];if(127===e)throw new y.AssertError("Encountered PRIM_CHUNK_END outside of chunked array!");if(0===(224&e))return n=1&e,s=e>>1&15,c=r.readTypedNum(n?m.UINT32:m.UINT16),d=r.readTypedArray(b.TO[s],c),l=new g[b.FROM[s]](d);if(32===(240&e))return n=1&e,s=e>>1&7,c=r.readTypedNum(n?m.UINT32:m.UINT16),o(r,t,c,s);if(48===(240&e))return n=1&e,s=e>>1&7,c=r.readTypedNum(n?m.UINT32:m.UINT16),a(r,t,c,s);if(64===(240&e))return n=1&e,s=e>>1&7,c=r.readTypedNum(n?m.UINT32:m.UINT16),d=r.readTypedNum(s),l=new g[s](c),l.fill(d),l;if(80===(240&e))return n=1&e,s=e>>1&7,c=r.readTypedNum(n?m.UINT32:m.UINT16),l=r.readTypedArray(s,c);if(96===(248&e))return s=7&e,c=r.readTypedNum(m.UINT8),l=r.readTypedArray(s,c);if(104===(254&e)){for(n=1&e,c=r.readTypedNum(n?m.UINT32:m.UINT16),d=T(r,t),l=new Array(c),i=0;c>i;i++)l[i]=d;return l}if(106===(254&e)){for(n=1&e,c=r.readTypedNum(n?m.UINT32:m.UINT16),i=0;c>i;++i)l.push(T(r,t));return l}if(124===(254&e))return n=1&e,c=r.readTypedNum(n?m.UINT32:m.UINT16),u(r,t,c);throw new y.AssertError("Unknown array op-code 0x"+e.toString(16)+" at offset @"+(r.i8-r.ofs8)+"!")}function T(r,t){var e=r.readTypedNum(m.UINT8);if(0===(128&e))return c(r,t,127&e);if(128===(192&e))return n(r,t,63&e);if(192===(224&e))return s(r,(24&e)>>3,7&e);if(224===(240&e)){var i=(15&e)<<16|r.readTypedNum(m.UINT16);if(i>=r.iref_table.length)throw new y.IRefError("Invalid IREF #"+i+"!");return r.iref_table[i]}if(240===(248&e))return r.readTypedNum(7&e);if(248===(252&e))return U[3&e];if(252===(254&e))return E[2&e];if(254===(255&e)){var a=r.readStringLT();if(void 0===t[a])throw new y.XRefError("Cannot import undefined external reference "+a+"!");return t[a]}if(255===(255&e))throw new y.AssertError("Encountered RESERVED primitive operator!")}function d(r,t){for(;!r.eof();){var e=r.readTypedNum(m.UINT8);switch(e){case 248:var i=r.prefix+r.readStringLT();t[i]=T(r,t);break;default:throw new y.AssertError("Unknown control operator 0x"+e.toString(16)+" at @"+r.i8+"!")}}}function l(r,t){var e=r.length,i=Array(e),s=!1;return r.forEach(function(n,a){var o=new XMLHttpRequest;o.open("GET",r[a]),o.responseType="arraybuffer",o.send(),o.addEventListener("readystatechange",function(){if(4===o.readyState)if(200===o.status)i[a]=o.response,0===--e&&t(null);else{if(s)return;t("Error loading "+r[a]+": "+o.statusText),s=!0}})}),i}var p=e(1),y=e(2);const N=0,I=1,m={UINT8:0,INT8:1,UINT16:2,INT16:3,UINT32:4,INT32:5,FLOAT32:6,FLOAT64:7},b={FROM:[m.UINT16,m.INT16,m.UINT32,m.INT32,m.UINT32,m.INT32,m.FLOAT32,m.FLOAT32,m.FLOAT32,m.FLOAT32,m.FLOAT64,m.FLOAT64,m.FLOAT64,m.FLOAT64,m.FLOAT64],TO:[m.UINT8,m.INT8,m.UINT8,m.INT8,m.UINT16,m.INT16,m.UINT8,m.INT8,m.UINT16,m.INT16,m.UINT8,m.INT8,m.UINT16,m.INT16,m.FLOAT32]},w={FROM:[m.UINT16,m.INT16,m.UINT32,m.INT32,m.UINT32,m.INT32],TO:[m.INT8,m.INT8,m.INT8,m.INT8,m.INT16,m.INT16]},v={FROM:[m.FLOAT32,m.FLOAT32,m.FLOAT64,m.FLOAT64],TO:[m.INT8,m.INT16,m.INT8,m.INT16]},g=[Uint8Array,Int8Array,Uint16Array,Int16Array,Uint32Array,Int32Array,Float32Array,Float64Array],A=([m.UINT16,m.UINT32],[m.UINT8,m.UINT16,m.UINT32,m.FLOAT64],{DEFINE:0,IREF:64,XREF:128}),U=[void 0,null,!1,!0],E=[NaN];var F=function(r,t,e){"object"==typeof t&&(e=t,t=""),this.database=e||{},this.baseDir=t||"",this.queuedRequests=[],this.objectTable=r,this.__delayGC=[]};F.prototype={constructor:F,add:function(r,t){var e="";this.baseDir&&(e=this.baseDir+"/");var i=r.split("?"),s="",n=[];if(i.length>1&&(s="?"+i[1]),".jbbp"===i[0].substr(i[0].length-5).toLowerCase()){var a=e+i[0].substr(0,i[0].length-5);n=[a+".jbbp",a+"_b16.jbbp",a+"_b32.jbbp",a+"_b64.jbbp"]}else{var r=i[0];".jbb"!=r.substr(r.length-4)&&(r+=".jbb"),n=[e+r+s]}var o={callback:t,status:N,buffer:void 0,url:n};this.queuedRequests.push(o)},addByBuffer:function(r){var t={callback:void 0,status:I,buffer:r,url:void 0};this.queuedRequests.push(t)},load:function(r){this.__process(r)},__process:function(r){var t=this;if(r||(r=function(){}),0===this.queuedRequests.length)return void r(null,this);for(var e=!1,i=0;i<this.queuedRequests.length;++i)if(this.queuedRequests[i].status===N){e=!0;break}if(e)for(var s={counter:0},n=function(){0===--this.counter&&t.__process(r)}.bind(s),a=!1,i=0;i<this.queuedRequests.length;++i){var o=this.queuedRequests[i];o.status===N&&(s.counter++,o.buffer=l(o.url,function(t){return function(e){if(e){if(a)return;var i="Error downloading bundle: "+e;return t.callback&&t.callback(i,null),r&&r(i,null),void(a=!0)}t.status=I,n()}}(o)))}else{for(var i=0;i<this.queuedRequests.length;++i){var o=this.queuedRequests[i];if(o.status===I){var h;h=1===o.buffer.length?new p(o.buffer[0],t.objectTable):new p(o.buffer,t.objectTable),d(h,t.database),o.callback&&o.callback(null,o.bundle)}}this.queuedRequests=[],r(null,this),setTimeout(function(){this.__delayGC=[]}.bind(this),500)}}},r.exports=F},function(r,t){"use strict";const e={UINT8:0,INT8:1,UINT16:2,INT16:3,UINT32:4,INT32:5,FLOAT32:6,FLOAT64:7};var i=function(r,t){this.ot=t,this.prefix="",this.sparse=r instanceof Array;var e,i,s,n=32;if(this.sparse?(this.u8=new Uint8Array(r[0]),this.s8=new Int8Array(r[0]),this.u16=new Uint16Array(r[1]),this.s16=new Int16Array(r[1]),this.u32=new Uint32Array(r[2]),this.s32=new Int32Array(r[2]),this.f32=new Float32Array(r[2]),this.f64=new Float64Array(r[3]),e=new Uint16Array(r[0],0,n/2),i=new Uint32Array(r[0],0,n/4),s=r[0].byteLength):(this.u8=new Uint8Array(r),this.s8=new Int8Array(r),this.u16=new Uint16Array(r),this.s16=new Int16Array(r),this.u32=new Uint32Array(r),this.s32=new Int32Array(r),this.f32=new Float32Array(r),this.f64=new Float64Array(r),e=new Uint16Array(r),i=new Uint32Array(r),s=r.byteLength),this.magic=e[0],this.table_id=e[1],this.version=e[2],this.ver_major=255&this.version,this.ver_minor=(65280&this.version)>>8,this.max64=i[2],this.max32=i[3],this.max16=i[4],this.max8=i[5],this.lenST=i[6],this.lenOT=i[7],12610==this.magic)throw{name:"EndianessError",message:"Unfortunately the JBB format is currently only compatible with Little-Endian CPUs",toString:function(){return this.name+": "+this.message}};if(16945!=this.magic)throw{name:"DecodingError",message:"This does not look like a JBB archive! (Magic is 0x"+this.magic.toString(16)+")",toString:function(){return this.name+": "+this.message}};if(258!=this.version)throw{name:"DecodingError",message:"Unsupported bundle version v"+this.ver_minor+"."+this.ver_minor,toString:function(){return this.name+": "+this.message}};if(this.table_id!=this.ot.ID)throw{name:"DecodingError",message:"The object table specified does not match the object table in the binary bundle (0x"+this.table_id.toString(16)+")",toString:function(){return this.name+": "+this.message}};this.sparse?(this.i64=0,this.i32=0,this.i16=0,this.i8=n,this.iEnd=this.i8+this.max8-this.lenST,this.ofs8=this.i8,this.ofs16=this.i16,this.ofs32=this.i32,this.ofs64=this.i64):(this.i64=n,this.i32=this.i64+this.max64,this.i16=this.i32+this.max32,this.i8=this.i16+this.max16,this.iEnd=this.i8+this.max8-this.lenST,this.ofs8=this.i8,this.ofs16=this.i16,this.ofs32=this.i32,this.ofs64=this.i64,this.i16/=2,this.i32/=4,this.i64/=8),this.iref_table=[];var a="",o=!1;if(this.string_table=[],this.lenST>0){for(var h=this.i8+this.max8,u=h-this.lenST;h>u;++u){var f=this.u8[u];0===f?(this.string_table.push(a),a="",o=!1):(a+=String.fromCharCode(f),o=!0)}o&&this.string_table.push(a)}var c=[],T=0,d=!1;if(this.signature_table=[],this.lenOT>0){for(var h=2*this.i16+this.max16,u=h-this.lenOT;h>u;u+=2){var f=this.u16[u/2];T--?c.push(this.string_table[f]):(d&&this.signature_table.push(c),c=[],T=f,d=!0)}d&&this.signature_table.push(c)}this.readTypedNum=function(r){switch(r){case 0:return this.u8[this.i8++];case 1:return this.s8[this.i8++];case 2:return this.u16[this.i16++];case 3:return this.s16[this.i16++];case 4:return this.u32[this.i32++];case 5:return this.s32[this.i32++];case 6:return this.f32[this.i32++];case 7:return this.f64[this.i64++]}},this.sparse?this.readTypedArray=function(t,e){var i;switch(t){case 0:return i=this.i8,this.i8+=e,new Uint8Array(r[0],i,e);case 1:return i=this.i8,this.i8+=e,new Int8Array(r[0],i,e);case 2:return i=2*this.i16,this.i16+=e,new Uint16Array(r[1],i,e);case 3:return i=2*this.i16,this.i16+=e,new Int16Array(r[1],i,e);case 4:return i=4*this.i32,this.i32+=e,new Uint32Array(r[2],i,e);case 5:return i=4*this.i32,this.i32+=e,new Int32Array(r[2],i,e);case 6:return i=4*this.i32,this.i32+=e,new Float32Array(r[2],i,e);case 7:return i=8*this.i64,this.i64+=e,new Float64Array(r[3],i,e)}}:this.readTypedArray=function(t,e){var i;switch(t){case 0:return i=this.i8,this.i8+=e,new Uint8Array(r,i,e);case 1:return i=this.i8,this.i8+=e,new Int8Array(r,i,e);case 2:return i=2*this.i16,this.i16+=e,new Uint16Array(r,i,e);case 3:return i=2*this.i16,this.i16+=e,new Int16Array(r,i,e);case 4:return i=4*this.i32,this.i32+=e,new Uint32Array(r,i,e);case 5:return i=4*this.i32,this.i32+=e,new Int32Array(r,i,e);case 6:return i=4*this.i32,this.i32+=e,new Float32Array(r,i,e);case 7:return i=8*this.i64,this.i64+=e,new Float64Array(r,i,e)}},this.factory_plain=[],this.factory_plain_bulk=[];for(var u=0;u<this.signature_table.length;++u){for(var l="return {",p=l,y=this.signature_table[u],N=y.length,I=0;N>I;++I)l+="'"+y[I]+"': values["+I+"],",p+="'"+y[I]+"': values["+I+"][i],";l+="}",p+="}",this.factory_plain.push(new Function("values",l)),this.factory_plain_bulk.push(new Function("values","i",p))}};i.prototype.readStringLT=function(){var r=this.readTypedNum(e.UINT16);if(r>=this.string_table.length)throw{name:"RangeError",message:"String ID is outside than the range of the string lookup table!",toString:function(){return this.name+": "+this.message}};return this.string_table[r]},i.prototype.eof=function(){return this.i8>=this.iEnd},i.prototype.where=function(){console.log("i8=",this.i8-this.ofs8," [U:",this.u8[this.i8],"0x"+this.u8[this.i8].toString(16),"/ S:",this.s8[this.i8],"]"),console.log("i16=",this.i16-this.ofs16/2," [U:",this.u16[this.i16],"/ S:",this.s16[this.i16],"]"),console.log("i32=",this.i32-this.ofs32/4," [U:",this.u32[this.i32],"/ S:",this.s32[this.i32],"/ F:",this.f32[this.i32],"]"),console.log("i64=",this.i64-this.ofs64/8," [F:",this.f64[this.i64],"]")},r.exports=i},function(r,t){"use strict";var e=function(r){var t=Error.call(this,r);t.name=this.name="EncodeError",this.stack=t.stack,this.message=t.message};e.prototype=Object.create(Error.prototype);var i=function(r){var t=Error.call(this,r);t.name=this.name="AssertError",this.stack=t.stack,this.message=t.message};i.prototype=Object.create(Error.prototype);var s=function(r){var t=Error.call(this,r);t.name=this.name="PackError",this.stack=t.stack,this.message=t.message};s.prototype=Object.create(Error.prototype);var n=function(r){var t=Error.call(this,r);t.name=this.name="RangeError",this.stack=t.stack,this.message=t.message};n.prototype=Object.create(Error.prototype);var a=function(r){var t=Error.call(this,r);t.name=this.name="IRefError",this.stack=t.stack,this.message=t.message};a.prototype=Object.create(Error.prototype);var o=function(r){var t=Error.call(this,r);t.name=this.name="XRefError",this.stack=t.stack,this.message=t.message};o.prototype=Object.create(Error.prototype),r.exports={EncodeError:e,AssertError:i,PackError:s,RangeError:n,IRefError:a,XRefError:o}}]);