/* JBB Binary Bundle Loader - https://github.com/wavesoft/jbb */
var JBBBinaryLoader=function(t){function r(i){if(e[i])return e[i].exports;var s=e[i]={exports:{},id:i,loaded:!1};return t[i].call(s.exports,s,s.exports,r),s.loaded=!0,s.exports}var e={};return r.m=t,r.c=e,r.p="",r(0)}([function(t,r,e){"use strict";function i(t,r){var e=t.readStringLT(),i=new Blob([t.readTypedArray(p.UINT8,r)],{type:e});return URL.createObjectURL(i)}function s(t,r,e){var s,n=[p.UINT8,p.UINT16,p.UINT32,p.FLOAT64][r],a=t.readTypedNum(n);if(0===e)return s=String.fromCharCode.apply(null,t.readTypedArray(p.UINT8,a));if(1===e)return s=String.fromCharCode.apply(null,t.readTypedArray(p.UINT16,a));if(2===e){var h=document.createElement("img");return h.src=i(t,a),h}if(4===e){var h=document.createElement("script");return h.src=i(t,a),h}if(7===e)return i(t,a);throw{name:"AssertError",message:"Unknown buffer type #"+e+"!",toString:function(){return this.name+": "+this.message}}}function n(t,r,e){if(!(32&e&&32!==(48&e))){var i=e;32&e&&(i=t.readTypedNum(p.UINT8)|(15&e)<<8);var s=t.ot.ENTITIES[i];if(void 0===s)throw{name:"AssertError",message:"Could not found known object entity #"+i+"!",toString:function(){return this.name+": "+this.message}};var n=s[1](s[0]);t.iref_table.push(n);var a=c(t,r);return s[2](n,t.ot.PROPERTIES[i],a),n}if(56!==(60&e)){if(48===(56&e)){var i=(7&e)<<8|t.readTypedNum(p.UINT8),h=t.factory_plain[i];if(void 0===h)throw{name:"AssertError",message:"Could not found simple object signature with id #"+i+"!",toString:function(){return this.name+": "+this.message}};var o=c(t,r);return h(o)}throw{name:"AssertError",message:"Unexpected object opcode 0x"+e.toString(16)+"!",toString:function(){return this.name+": "+this.message}}}var u=3&e;switch(u){case 0:var f=t.readTypedNum(p.FLOAT64);10*t.readTypedNum(p.INT8);return new Date(f);default:throw{name:"AssertError",message:"Unknown primitive object with POID #"+u+"!",toString:function(){return this.name+": "+this.message}}}}function a(t,r,e,i){for(var s=new U[b.FROM[i]](e),n=b.TO[i],a=t.readTypedNum(b.FROM[i]),h=t.readTypedNum(p.FLOAT64),o=t.readTypedArray(n,e),u=0;e>u;++u)s[u]=a+o[u]*h,console.log("<<<",o[u],"->",s[u]);return s}function h(t,r,e,i){var s=new U[I.FROM[i]](e),n=t.readTypedNum(I.FROM[i]),a=t.readTypedArray(I.TO[i],e-1);s[0]=n;for(var h=0,o=a.length;o>h;++h)n+=a[h],s[h+1]=n;return s}function o(t,r){var e=t.readTypedNum(p.UINT16),i=t.signature_table[e],s=t.factory_plain_bulk[e];if(!i)throw{name:"AssertError",message:"Unknown plain object with signature #"+e+"!",toString:function(){return this.name+": "+this.message}};for(var n=[],a=0,h=i.length;h>a;++a)n.push(c(t,r));for(var o=[],u=n[0].length,a=0;u>a;++a)o.push(s(n,a));return o}function u(t,r,e){var i,s,n,a,h,o,u=t.readTypedNum(p.UINT16),f=t.ot.PROPERTIES[u],T=t.ot.ENTITIES[u],d=f.length,l=[],m=(Array(e),Array(e)),g=0,y=0,N=0,I=[],b=[],U=0,v="";for(g=0;e>g;)switch(a=t.readTypedNum(p.UINT8),h=63&a,192&a){case A.DEFINE:for(y=0;h>y;y++)i=T[1](T[0]),t.iref_table.push(i),b.push(i);g+=h,I.push([192&a,h]);break;case A.IREF:case A.XREF:g+=1,I.push([192&a,h]);break;default:throw{name:"AssertError",message:"Unknown bulk array op-code 0x"+a.toString(16)+"!",toString:function(){return this.name+": "+this.message}}}for(g=0;d>g;++g)l.push(c(t,r)),v&&(v+=","),v+="p["+g+"][i]";for(o=new Function("p","i","return ["+v+"]"),g=0,N=0;N<I.length;N++)switch(a=I[N][0],h=I[N][1],a){case A.DEFINE:for(y=0;h>y;y++)i=b[U],T[2](i,f,o(l,U)),m[g++]=i,U++;break;case A.IREF:if(s=t.readTypedNum(p.UINT16),s>=t.iref_table.length)throw{name:"IrefError",message:"Invalid IREF #"+s+"!",toString:function(){return this.name+": "+this.message}};m[g++]=t.iref_table[h<<16|s];break;case A.XREF:if(n=t.readStringLT(),void 0===r[n])throw{name:"ImportError",message:"Cannot import undefined external reference "+n+"!",toString:function(){return this.name+": "+this.message}};m[g++]=r[n]}return m}function f(t,r){for(var e,i=t.readTypedNum(p.UINT8),s=[];127!==i;){if(e=T(t,r,i),void 0===e.length)throw{name:"AssertError",message:"Encountered non-array chunk as part of chunked array!",toString:function(){return this.name+": "+this.message}};s.push.apply(s,e),i=t.readTypedNum(p.UINT8)}return s}function T(t,r,e){var i,s,n,T,d,l=[];if(108===e)return o(t,r);if(110===e){for(T=t.readTypedNum(p.UINT8),i=0;T>i;++i)l.push(c(t,r));return l}if(111===e)return f(t,r);if(126===e)return[];if(127===e)throw{name:"AssertError",message:"Encountered PRIM_CHUNK_END outside of chunked array!",toString:function(){return this.name+": "+this.message}};if(0===(224&e))return n=1&e,s=e>>1&15,T=t.readTypedNum(n?p.UINT32:p.UINT16),d=t.readTypedArray(N.TO[s],T),l=new U[N.FROM[s]](d);if(32===(240&e))return n=1&e,s=e>>1&7,T=t.readTypedNum(n?p.UINT32:p.UINT16),h(t,r,T,s);if(48===(240&e))return n=1&e,s=e>>1&7,T=t.readTypedNum(n?p.UINT32:p.UINT16),a(t,r,T,s);if(64===(240&e))return n=1&e,s=e>>1&7,T=t.readTypedNum(n?p.UINT32:p.UINT16),d=t.readTypedNum(s),l=new U[s](T),l.fill(d),l;if(80===(240&e))return n=1&e,s=e>>1&7,T=t.readTypedNum(n?p.UINT32:p.UINT16),l=t.readTypedArray(s,T);if(96===(248&e))return s=7&e,T=t.readTypedNum(p.UINT8),l=t.readTypedArray(s,T);if(104===(254&e))return n=1&e,T=t.readTypedNum(n?p.UINT32:p.UINT16),d=c(t,r),l=new Array(T),l.fill(d),l;if(106===(254&e)){for(n=1&e,T=t.readTypedNum(n?p.UINT32:p.UINT16),i=0;T>i;++i)l.push(c(t,r));return l}if(124===(254&e))return n=1&e,T=t.readTypedNum(n?p.UINT32:p.UINT16),u(t,r,T);throw{name:"AssertError",message:"Unknown array op-code 0x"+e.toString(16)+" at offset @"+(t.i8-t.ofs8)+"!",toString:function(){return this.name+": "+this.message}}}function c(t,r){var e=t.readTypedNum(p.UINT8);if(0===(128&e))return T(t,r,127&e);if(128===(192&e))return n(t,r,63&e);if(192===(224&e))return s(t,(24&e)>>3,7&e);if(224===(240&e)){var i=(15&e)<<16|t.readTypedNum(p.UINT16);if(i>=t.iref_table.length)throw{name:"IrefError",message:"Invalid IREF #"+i+"!",toString:function(){return this.name+": "+this.message}};return t.iref_table[i]}if(240===(248&e))return t.readTypedNum(7&e);if(248===(252&e))return v[3&e];if(252===(254&e))return w[2&e];if(254===(255&e)){var a=t.readStringLT();if(void 0===r[a])throw{name:"ImportError",message:"Cannot import undefined external reference "+a+"!",toString:function(){return this.name+": "+this.message}};return r[a]}if(255===(255&e))throw{name:"AssertError",message:"Encountered RESERVED primitive operator!",toString:function(){return this.name+": "+this.message}}}function d(t,r){for(;!t.eof();){var e=t.readTypedNum(p.UINT8);switch(e){case 248:var i=t.prefix+t.readStringLT();r[i]=c(t,r);break;default:throw{name:"AssertError",message:"Unknown control operator 0x"+e.toString(16)+" at @"+t.i8+"!",toString:function(){return this.name+": "+this.message}}}}}function l(t,r){var e=t.length,i=Array(e),s=!1;return t.forEach(function(n,a){var h=new XMLHttpRequest;h.open("GET",t[a]),h.responseType="arraybuffer",h.send(),h.addEventListener("readystatechange",function(){if(4===h.readyState)if(200===h.status)i[a]=h.response,0===--e&&r(null);else{if(s)return;r("Error loading "+t[a]+": "+h.statusText),s=!0}})}),i}var m=e(1);const g=0,y=1,p={UINT8:0,INT8:1,UINT16:2,INT16:3,UINT32:4,INT32:5,FLOAT32:6,FLOAT64:7},N={FROM:[p.UINT16,p.INT16,p.UINT32,p.INT32,p.UINT32,p.INT32,p.FLOAT32,p.FLOAT32,p.FLOAT32,p.FLOAT32,p.FLOAT64,p.FLOAT64,p.FLOAT64,p.FLOAT64,p.FLOAT64],TO:[p.UINT8,p.INT8,p.UINT8,p.INT8,p.UINT16,p.INT16,p.UINT8,p.INT8,p.UINT16,p.INT16,p.UINT8,p.INT8,p.UINT16,p.INT16,p.FLOAT32]},I={FROM:[p.UINT16,p.INT16,p.UINT32,p.INT32,p.UINT32,p.INT32],TO:[p.INT8,p.INT8,p.INT8,p.INT8,p.INT16,p.INT16]},b={FROM:[p.FLOAT32,p.FLOAT32,p.FLOAT64,p.FLOAT64],TO:[p.INT8,p.INT16,p.INT8,p.INT16]},U=[Uint8Array,Int8Array,Uint16Array,Int16Array,Uint32Array,Int32Array,Float32Array,Float64Array],A=([p.UINT16,p.UINT32],[p.UINT8,p.UINT16,p.UINT32,p.FLOAT64],{DEFINE:0,IREF:64,XREF:128}),v=[void 0,null,!1,!0],w=[NaN];var E=function(t,r,e){"object"==typeof r&&(e=r,r=""),this.database=e||{},this.baseDir=r||"",this.queuedRequests=[],this.objectTable=t,this.__delayGC=[]};E.prototype={constructor:E,add:function(t,r){var e="";this.baseDir&&(e=this.baseDir+"/");var i=t.split("?"),s="",n=[];if(i.length>1&&(s="?"+i[1]),".jbbp"===i[0].substr(i[0].length-5).toLowerCase()){var a=e+i[0].substr(0,i[0].length-5);n=[a+".jbbp",a+"_b16.jbbp",a+"_b32.jbbp",a+"_b64.jbbp"]}else{var t=i[0];".jbb"!=t.substr(t.length-4)&&(t+=".jbb"),n=[e+t+s]}var h={callback:r,status:g,buffer:void 0,url:n};this.queuedRequests.push(h)},addByBuffer:function(t){var r={callback:void 0,status:y,buffer:t,url:void 0};this.queuedRequests.push(r)},load:function(t){this.__process(t)},__process:function(t){var r=this;if(t||(t=function(){}),0===this.queuedRequests.length)return void t(null,this);for(var e=!1,i=0;i<this.queuedRequests.length;++i)if(this.queuedRequests[i].status===g){e=!0;break}if(e)for(var s={counter:0},n=function(){0===--this.counter&&r.__process(t)}.bind(s),a=!1,i=0;i<this.queuedRequests.length;++i){var h=this.queuedRequests[i];h.status===g&&(s.counter++,h.buffer=l(h.url,function(r){return function(e){if(e){if(a)return;var i="Error downloading bundle: "+e;return r.callback&&r.callback(i,null),t&&t(i,null),void(a=!0)}r.status=y,n()}}(h)))}else{for(var i=0;i<this.queuedRequests.length;++i){var h=this.queuedRequests[i];if(h.status===y){var o;o=1===h.buffer.length?new m(h.buffer[0],r.objectTable):new m(h.buffer,r.objectTable),d(o,r.database),h.callback&&h.callback(null,h.bundle)}}this.queuedRequests=[],t(null,this),setTimeout(function(){this.__delayGC=[]}.bind(this),500)}}},t.exports=E},function(t,r){"use strict";const e={UINT8:0,INT8:1,UINT16:2,INT16:3,UINT32:4,INT32:5,FLOAT32:6,FLOAT64:7};var i=function(t,r){this.ot=r,this.prefix="",this.sparse=t instanceof Array;var e,i,s,n=32;if(this.sparse?(this.u8=new Uint8Array(t[0]),this.s8=new Int8Array(t[0]),this.u16=new Uint16Array(t[1]),this.s16=new Int16Array(t[1]),this.u32=new Uint32Array(t[2]),this.s32=new Int32Array(t[2]),this.f32=new Float32Array(t[2]),this.f64=new Float64Array(t[3]),e=new Uint16Array(t[0],0,n/2),i=new Uint32Array(t[0],0,n/4),s=t[0].byteLength):(this.u8=new Uint8Array(t),this.s8=new Int8Array(t),this.u16=new Uint16Array(t),this.s16=new Int16Array(t),this.u32=new Uint32Array(t),this.s32=new Int32Array(t),this.f32=new Float32Array(t),this.f64=new Float64Array(t),e=new Uint16Array(t),i=new Uint32Array(t),s=t.byteLength),this.magic=e[0],this.table_id=e[1],this.version=e[2],this.ver_major=255&this.version,this.ver_minor=(65280&this.version)>>8,this.max64=i[2],this.max32=i[3],this.max16=i[4],this.max8=i[5],this.lenST=i[6],this.lenOT=i[7],12610==this.magic)throw{name:"EndianessError",message:"Unfortunately the JBB format is currently only compatible with Little-Endian CPUs",toString:function(){return this.name+": "+this.message}};if(16945!=this.magic)throw{name:"DecodingError",message:"This does not look like a JBB archive! (Magic is 0x"+this.magic.toString(16)+")",toString:function(){return this.name+": "+this.message}};if(258!=this.version)throw{name:"DecodingError",message:"Unsupported bundle version v"+this.ver_minor+"."+this.ver_minor,toString:function(){return this.name+": "+this.message}};if(this.table_id!=this.ot.ID)throw{name:"DecodingError",message:"The object table specified does not match the object table in the binary bundle (0x"+this.table_id.toString(16)+")",toString:function(){return this.name+": "+this.message}};this.sparse?(this.i64=0,this.i32=0,this.i16=0,this.i8=n,this.iEnd=this.i8+this.max8-this.lenST,this.ofs8=this.i8,this.ofs16=this.i16,this.ofs32=this.i32,this.ofs64=this.i64):(this.i64=n,this.i32=this.i64+this.max64,this.i16=this.i32+this.max32,this.i8=this.i16+this.max16,this.iEnd=this.i8+this.max8-this.lenST,this.ofs8=this.i8,this.ofs16=this.i16,this.ofs32=this.i32,this.ofs64=this.i64,this.i16/=2,this.i32/=4,this.i64/=8),this.iref_table=[];var a="",h=!1;if(this.string_table=[],this.lenST>0){for(var o=this.i8+this.max8,u=o-this.lenST;o>u;++u){var f=this.u8[u];0===f?(this.string_table.push(a),a="",h=!1):(a+=String.fromCharCode(f),h=!0)}h&&this.string_table.push(a)}var T=[],c=0,d=!1;if(this.signature_table=[],this.lenOT>0){for(var o=2*this.i16+this.max16,u=o-this.lenOT;o>u;u+=2){var f=this.u16[u/2];c--?T.push(this.string_table[f]):(d&&this.signature_table.push(T),T=[],c=f,d=!0)}d&&this.signature_table.push(T)}this.readTypedNum=function(t){switch(t){case 0:return this.u8[this.i8++];case 1:return this.s8[this.i8++];case 2:return this.u16[this.i16++];case 3:return this.s16[this.i16++];case 4:return this.u32[this.i32++];case 5:return this.s32[this.i32++];case 6:return this.f32[this.i32++];case 7:return this.f64[this.i64++]}},this.sparse?this.readTypedArray=function(r,e){var i;switch(r){case 0:return i=this.i8,this.i8+=e,new Uint8Array(t[0],i,e);case 1:return i=this.i8,this.i8+=e,new Int8Array(t[0],i,e);case 2:return i=2*this.i16,this.i16+=e,new Uint16Array(t[1],i,e);case 3:return i=2*this.i16,this.i16+=e,new Int16Array(t[1],i,e);case 4:return i=4*this.i32,this.i32+=e,new Uint32Array(t[2],i,e);case 5:return i=4*this.i32,this.i32+=e,new Int32Array(t[2],i,e);case 6:return i=4*this.i32,this.i32+=e,new Float32Array(t[2],i,e);case 7:return i=8*this.i64,this.i64+=e,new Float64Array(t[3],i,e)}}:this.readTypedArray=function(r,e){var i;switch(r){case 0:return i=this.i8,this.i8+=e,new Uint8Array(t,i,e);case 1:return i=this.i8,this.i8+=e,new Int8Array(t,i,e);case 2:return i=2*this.i16,this.i16+=e,new Uint16Array(t,i,e);case 3:return i=2*this.i16,this.i16+=e,new Int16Array(t,i,e);case 4:return i=4*this.i32,this.i32+=e,new Uint32Array(t,i,e);case 5:return i=4*this.i32,this.i32+=e,new Int32Array(t,i,e);case 6:return i=4*this.i32,this.i32+=e,new Float32Array(t,i,e);case 7:return i=8*this.i64,this.i64+=e,new Float64Array(t,i,e)}},this.factory_plain=[],this.factory_plain_bulk=[];for(var u=0;u<this.signature_table.length;++u){for(var l="return {",m=l,g=this.signature_table[u],y=g.length,p=0;y>p;++p)l+="'"+g[p]+"': values["+p+"],",m+="'"+g[p]+"': values["+p+"][i],";l+="}",m+="}",this.factory_plain.push(new Function("values",l)),this.factory_plain_bulk.push(new Function("values","i",m))}};i.prototype.readStringLT=function(){var t=this.readTypedNum(e.UINT16);if(t>=this.string_table.length)throw{name:"RangeError",message:"String ID is outside than the range of the string lookup table!",toString:function(){return this.name+": "+this.message}};return this.string_table[t]},i.prototype.eof=function(){return this.i8>=this.iEnd},i.prototype.where=function(){console.log("i8=",this.i8-this.ofs8," [U:",this.u8[this.i8],"0x"+this.u8[this.i8].toString(16),"/ S:",this.s8[this.i8],"]"),console.log("i16=",this.i16-this.ofs16/2," [U:",this.u16[this.i16],"/ S:",this.s16[this.i16],"]"),console.log("i32=",this.i32-this.ofs32/4," [U:",this.u32[this.i32],"/ S:",this.s32[this.i32],"/ F:",this.f32[this.i32],"]"),console.log("i64=",this.i64-this.ofs64/8," [F:",this.f64[this.i64],"]")},t.exports=i}]);